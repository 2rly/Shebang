import type { ExploitDBResult } from "@/types/intelligence";
import type { ServiceResponse } from "../types";
import { checkRateLimit } from "../rate-limiter";

const SHODAN_KEY = process.env.SHODAN_API_KEY;

export async function searchExploits(
  query: string,
  limit = 20
): Promise<ServiceResponse<ExploitDBResult>> {
  if (!checkRateLimit("exploitdb", 5, 10_000)) {
    return {
      success: false,
      error: {
        code: "RATE_LIMIT",
        message: "Exploit-DB rate limit exceeded",
        retryAfter: 10,
      },
    };
  }

  try {
    // Try Shodan Exploits API first (requires Shodan key)
    if (SHODAN_KEY) {
      const res = await fetch(
        `https://exploits.shodan.io/api/search?query=${encodeURIComponent(query)}&key=${SHODAN_KEY}`,
        { signal: AbortSignal.timeout(15_000) }
      );

      if (res.ok) {
        const data = await res.json();
        const exploits = (data.matches || []).slice(0, limit).map((e: any) => ({
          id: e.id?.toString() || "",
          title: e.description || "",
          description: e.description || "",
          date: e.date || "",
          author: e.author || "Unknown",
          type: e.type || "unknown",
          platform: e.platform || "multiple",
          url: e.source || `https://www.exploit-db.com/exploits/${e.id}`,
        }));

        return {
          success: true,
          data: { exploits, total: data.total || exploits.length },
        };
      }
    }

    // Fallback: scrape Exploit-DB search page
    const res = await fetch(
      `https://www.exploit-db.com/search?q=${encodeURIComponent(query)}`,
      {
        headers: {
          "User-Agent": "Mozilla/5.0 (compatible; CyberHub/1.0)",
          Accept: "application/json, text/html",
        },
        signal: AbortSignal.timeout(15_000),
      }
    );

    if (!res.ok) {
      return {
        success: false,
        error: {
          code: "API_ERROR",
          message: `Exploit-DB returned ${res.status}`,
        },
      };
    }

    // Try to parse as JSON (Exploit-DB sometimes returns JSON for API-like requests)
    const text = await res.text();
    try {
      const data = JSON.parse(text);
      const exploits = (data.data || []).slice(0, limit).map((e: any) => ({
        id: e.id?.toString() || "",
        title: e.description?.[1] || e.description || "",
        description: e.description?.[1] || "",
        date: e.date_published || "",
        author: e.author?.[1] || "Unknown",
        type: e.type?.[1] || "unknown",
        platform: e.platform?.[1] || "multiple",
        url: `https://www.exploit-db.com/exploits/${e.id}`,
      }));

      return {
        success: true,
        data: { exploits, total: data.recordsTotal || exploits.length },
      };
    } catch {
      // If not JSON, return empty result
      return {
        success: true,
        data: { exploits: [], total: 0 },
      };
    }
  } catch (err: any) {
    return {
      success: false,
      error: { code: "API_ERROR", message: err.message ?? "Unknown error" },
    };
  }
}
